---
title: "OOPSLA20 Artifact - Designing Types for R, Empirically"
authors: "Alexi Turcotte, Aviral Goel, Filip Krikava and Jan Vitek"
output: 
  html_document: 
    theme: journal
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(viewer)

knitr::opts_chunk$set(echo = TRUE)
```

## Artifact Description

This is the artifact for the OOPSLA 2020 paper *Designing Types for R, Empirically*.
The aim is to:

1.  show the tools that were developed to infer and assert types for R
    functions,
2.  demonstrate the entire pipeline used to infer types for R packages.

The artifact is composed of two parts: 

1. a getting started guide that contains the setup instructions and a small
   experiment to verify that all works, and
2. a step-by-step instructions on how the tooling developed for this paper work
   and a complete pipeline which reproduces the data reported in the paper.

## Requirements 

The pipeline depends on a number of tools and R packages:

- bash
- git
- GNU parallel >= 20190322
- GNU bison >= 3.5
- GNU make >= 4.1
- [R](https://cran.r-project.org) == 3.5.0
- [R-dyntrace](https://github.com/PRL-PRG/R-dyntrace) 3.5.0
- a number of our R packages with their dependencies
  - [contractr](https://github.com/PRL-PRG/contractr) - runtime type assertions
  - [injectr](https://github.com/PRL-PRG/injectr) - for injecting code into R functions
  - [propagatr](https://github.com/PRL-PRG/propagatr) - tracing type usage
  - [runr](https://github.com/PRL-PRG/runr) - running the experiments
  - [tastr](https://github.com/PRL-PRG/tastr) - grammar and parser for our R types

and of course a corpus of R packages to be run.

To make it more convenient we have build a docker image that has all these dependencies installed.
The image can be pulled directly from [Docker HUB](https://hub.docker.com/r/prlprg/oopsla20-typer) or <a href="#building-image-locally">built locally</a>.
To use the image, you will need:
- [docker community edition](https://docs.docker.com/install/) version 18+, and 
- bash.

This artifact requires about ~10GB of free space, depending on the number of packages that should be analyzed.
It has been tested on Linux (Manjaro 19 and Ubuntu 18.04).

## Getting Started Guide

For the initial kick-the-tires phase, please go over the following steps to determine if the artifact is usable in your environment.

1. Clone the artifact git repository

```{sh eval=FALSE}
git clone https://github.com/PRL-PRG/OOPSLA20-typer-artifact
cd OOPSLA20-typer-artifact
```

We will refer to the directory in where the artifact is cloned as `$REPO`.
The content of the artifact is discussed in <a href="#artifact-structure">later section</a>.

1. Run RStudio from the artifact docker container

A part of the artifact evaluation can be done from within an interactive session in an [RStudio](https://rstudio.com).
The following command will pull the docker image and start an instance of RStudio at the port 8787.
If you need to use an alternative port, you can specify it using `-p PORT` argument.

```{sh eval=FALSE}
./run.sh
```

Once you see an output like:

```text
[services.d] starting services
[services.d] done.
```

you should be able to access RStudio in your browser at [http://localhost:8787](http://localhost:8787).

To terminate it, simply interrupt the process by pressing `Ctrl-C` / `Command-C`.

1. Open this `README.Rmd` in RStudio

The rest of the steps can be done in the RStudio.
To do that, open this `README.Rmd` file by either navigating to `File` -> `Open File...` menu item or
by running:

```{r eval=FALSE}
navigateToFile("~/README.Rmd")
```

in the R interpreter.
The rest of the command snippets can be run from within R by either clicking the play icon next to the snipper or pressing `Ctrl+Enter` / `Command+Enter`.

1. Check that RStudio can see all installed packages.

First, we need to make sure RStudio sees all the installed packages.

```{r}
length(installed.packages()[,1])
```

The number should be over 600.

1. Knit `corpus-analysis.Rmd`

Next, we try to build the corpus analyzing notebook.
This can be done with the following command:

```{r eval=FALSE}
rmarkdown::render("~/typeR/analysis/corpus-analysis.Rmd")
```

which, if successfull, generates an HTML file in `~/typeR/analysis/corpus-analysis.Rmd`.
To view it, either open it in the navigator on the right side or run:

```{r eval=FALSE}
viewer("~/typeR/analysis/corpus-analysis.html")
```

1. Try to infer types for tiny corpus of just 2 packages

For the last test, we will try to run the type infering pipeline for two packages.

This has to be done in a terminal. 
Navigate to the `$REPO/typeR` and run the following:

```{sh eval=FALSE}
./in-docker.sh make tasks/infer-types PACKAGES_FILE=packages-tiny-corpus.txt JOBS=1
```

The `make` command must be prefixed with `in-docker.sh` as we want to run it inside a docker container.

TODO describe the result

This concludes the getting started guide and the kick the tires part.

## Step-by-step Instructions

### Quick Tutorial

This should happen in Rstudio

#### Types for R functions

#### Types for R packages

#### Inferring Types from R Code

### Redoing the Paper Experiment

This will happen in command line

#### Artifact Structure
<a name="#artifact-structure"/>

Before we ...

#### The Docker Image

```
/R
/typeR
```

#### Corpus

In this section we show how to generate data presented in __Chapter 5 - Project
Corpus_. We do this in a separate notebook:
`~/typeR/analysis/corpus-analysis.Rmd`.
If you have completed the getting started guide, you have already ran this notebook.
Here we give more details about how it works.

It loads the metadata collected for the whole of CRAN, namely:
- ``
- ``

Since generating this file requires to have all the CRAN packages installed, we
only include the result.

TODO include examples of running all the tasks on a smaller data set. 

To knit the notebook, run:

```{r eval=FALSE}
rmarkdown::render("~/typeR/analysis/corpus-analysis.Rmd")
```

This will generate the following files:

- `corpus-analysis.html`: an HTML file rendering the notebook

```{r}
viewer("~/typeR/analysis/corpus-analysis.html")
```

- `corpus.tex`: a Latex file with the raw data to be included in the paper

```{r}
viewer("~/typeR/paper/corpus.tex")
```

- `corpus.pdf`: a plot of the corpus 

```{r eval=FALSE}
viewer("~/typeR/paper/plots/corpus.pdf")
```

## Building Image Locally
<a name="#building-image-locally"/>

To build image locally you can either use make by running:

```{sh eval=FALSE}
make .docker-build
```

## Toubleshooting

### Docker on OSX

It is better to use homebrew cask to install docker:

```sh
brew cask install docker
```

in case you see `docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?.` error message
cf: https://stackoverflow.com/a/44719239

### Docker on Linux

In some distribution the package does not add the current user to `docker` group.
In this case, either add yourself to `docker` group or run all docker-related command with `sudo`.

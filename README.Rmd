---
title: "OOPSLA20 Artifact - Designing Types for R, Empirically"
authors: "Alexi Turcotte, Aviral Goel, Filip Krikava and Jan Vitek"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

## Artifact Description

This is the artifact for the OOPSLA 2020 paper *Designing Types for R, Empirically*.
The aim is to:

1.  show the tools that were developed to infer and assert types for R
    functions,
2.  demonstrate the entire pipeline used to infer types for R packages.

The artifact is composed of two parts: 

1. a getting started guide that contains the setup instructions and a small
   experiment to verify that all works, and
2. a step-by-step instructions on how the tooling developed for this paper work
   and a complete pipeline which reproduces the data reported in the paper.

## Requirements 

The pipeline depends on a number of tools and R packages:

- git >= 2
- bash >= 4
- GNU parallel >= 20190322
- GNU bison >= 3.5
- R == 3.5.0
- R packages
  - [rapr](https://github.com/PRL-PRG/rapr)_for running the experiments
  - [contractr](https://github.com/PRL-PRG/contractr)
  - ...


To make it more convenient we have build a docker image that has all these dependencies installed.
The image is available on [Docker HUB](https://hub.docker.com/r/prlprg/oopsla20-typer).
This image can be either pulled directly from the Hub or <a href="#building-image-locally">built locally</a>.
To run the image, you will need [docker community edition](https://docs.docker.com/install/) version 18+ and bash.

This artifact requires about ~10GB of free space, depending on the number of packages that should be analyzed..

## Getting Started Guide

1. Clone the artifact git repository

```{sh eval=FALSE}
git clone https://github.com/PRL-PRG/OOPSLA20-typer-artifact
cd OOPSLA20-typer-artifact
```

The actual content of the artifact will be discussed in later sections.

1. Run RStudio from the artifact docker container

```{sh eval=FALSE}
./run-rstudio.sh
```

This shall start an [RStudio](https://rstudio.com/) on [http://localhost:8787](http://localhost:8787).
If you want to use an alternative port, you can specify it as an argument to the script above.

To terminate it, at any time send a `SIGINT` (`Ctrl-C`) to the process.

1. Open this `README.Rmd`

This can be done by either navigating to `File` -> `Open File...` menu item or
by running:

```{r eval=FALSE}
rstudioapi::navigateToFile("~/README.Rmd")
```

1. Check that RStudio can see all installed packages.

Check that Rstudio can see the installed corpus.
The number of installed packages should be 603.

```{r}
length(installed.packages()[,1])
```

1. Knit `corpus-analysis.Rmd`

1. Try to infer types for tiny corpus of just 2 packages

In the checkouted artifact repository, run the following

```{r}
cd typeR
./run.sh make tasks/package-runnable-code-propagatr PACKAGES_FILE=/typeR/packages-tiny-corpus.txt JOBS=2
./run.sh make tasks/run-extracted-code-propagatr PACKAGES_FILE=/typeR/packages-tiny-corpus.txt JOBS=2
```

The results will be placed in `run/package-runnable-code-propagatr` ...

This concludes the getting started guide and the kick the tires part.

## Step-by-step Instructions

### Quick Tutorial

This should happen in Rstudio

#### Types for R functions

#### Types for R packages

#### Inferring Types from R Code

### Redoing the Paper Experiment

This will happen in command line

#### Structure of the Artifact

#### The Docker Image

```
/R
/typeR
/envir
/envir-dyntrace
```

#### Corpus

In this section we show how to generate data presented in __Chapter 5 - Project
Corpus_. We do this in a separate notebook:
`~/typeR/analysis/corpus-analysis.Rmd`.

It loads the metadata collected for the whole of CRAN, namely:
- ``
- ``

Since generating this file requires to have all the CRAN packages installed, we
only include the result.

TODO include examples of running all the tasks on a smaller data set. 

To knit the notebook, run:

```{r}
rmarkdown::render("~/typeR/analysis/corpus-analysis.Rmd")
```

This will generate the following files:

- an HTML file rendering the notebook

```{r}
rstudioapi::viewer("~/typeR/analysis/corpus-analysis.html")
```

- a Latex file with the raw data to be included in the paper

```{r}
rstudioapi::viewer("~/typeR/paper/corpus.tex")
```

- a plot of the corpus

```{r eval=FALSE}
rstudioapi::navigateToFile("~/typeR/plots/corpus.pdf")
```


## Artifact Structure

TODO

## Building Image Locally
<a name="#building-image-locally"/>

To build image locally you can either use make by running:

```{sh eval=FALSE}
make .docker-build
```

## Toubleshooting

### Docker on OSX

It is better to use homebrew cask to install docker:

```sh
brew cask install docker
```

in case you see `docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?.` error message
cf: https://stackoverflow.com/a/44719239

### Docker on Linux

In some distribution the package does not add the current user to `docker` group.
In this case, either add yourself to `docker` group or run all docker-related command with `sudo`.
